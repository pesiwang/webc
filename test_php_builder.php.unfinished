<?php
require_once __DIR__ . '/builder.class.php';
require_once __DIR__ . '/3party/smarty/Smarty.class.php';

class ClientPhpBuilder extends Builder {

	public function build() {
		$smarty = $this->getSmarty();
		$content = $smarty->fetch(__DIR__ . '/server/php/webc.class.tpl');
		$this->saveFile('/lib/webc.class.php', $content);

		foreach ($this->_sourceFiles as $sourceFile) {
			$parser = $this->getParser($sourceFile);
			$smarty = $this->getSmarty();
			$smarty->assign('structs', $parser->getStructs());
			$content = $smarty->fetch(__DIR__ . '/client/php/objects.class.tpl');
			$this->saveFile('/v' . $parser->getVersion() . '/objects.class.php', $content);

			$smarty = $this->getSmarty();
			$smarty->assign('interfaces', $parser->getInterfaces());
			$smarty->assign('version', $parser->getVersion());
			$content = $smarty->fetch(__DIR__ . '/client/php/client.class.tpl');
			$this->saveFile('/v' . $parser->getVersion() . '/client.class.php', $content);
		}
	}
}

if($argc < 3)
	die("usage: php " . $argv[0] . " <source_folder> <target_folder>\n");

try{
	$builder = new ClientPhpBuilder($argv[1], $argv[2]);
	$builder->build();
}
catch(Exception $e){
	die("compilation failed, reason:" . $e->getMessage() . "\n");
}
